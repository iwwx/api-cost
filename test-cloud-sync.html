<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº‘ç«¯åŒæ­¥åŠŸèƒ½æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .status.syncing {
      background: #e3f2fd;
      color: #1976d2;
    }
    .status.synced {
      background: #e8f5e9;
      color: #388e3c;
    }
    .status.error {
      background: #ffebee;
      color: #d32f2f;
    }
    .section {
      margin-bottom: 30px;
    }
    .section h2 {
      font-size: 18px;
      color: #555;
      margin-bottom: 15px;
    }
    .info-box {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      margin-bottom: 10px;
    }
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #1565c0;
    }
    button.secondary {
      background: #757575;
    }
    button.secondary:hover {
      background: #616161;
    }
    button.danger {
      background: #d32f2f;
    }
    button.danger:hover {
      background: #c62828;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
    }
    .log {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      margin-top: 15px;
    }
    .log-entry {
      margin-bottom: 5px;
    }
    .log-time {
      color: #64b5f6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ äº‘ç«¯åŒæ­¥åŠŸèƒ½æµ‹è¯•</h1>
    <div id="status" class="status syncing">
      <span>â³</span>
      <span id="status-text">åˆå§‹åŒ–ä¸­...</span>
    </div>

    <!-- è®¾å¤‡ä¿¡æ¯ -->
    <div class="section">
      <h2>ğŸ“± è®¾å¤‡ä¿¡æ¯</h2>
      <div class="info-box">
        <div><strong>è®¾å¤‡ ID:</strong> <span id="device-id">åŠ è½½ä¸­...</span></div>
        <div><strong>äº‘ç«¯åŒæ­¥:</strong> <span id="sync-enabled">åŠ è½½ä¸­...</span></div>
        <div><strong>ä¸Šæ¬¡åŒæ­¥:</strong> <span id="last-sync">ä»æœªåŒæ­¥</span></div>
      </div>
      <button onclick="copyDeviceId()">å¤åˆ¶è®¾å¤‡ ID</button>
      <button class="secondary" onclick="generateNewDeviceId()">ç”Ÿæˆæ–°è®¾å¤‡ ID</button>
    </div>

    <!-- æµ‹è¯•æ•°æ® -->
    <div class="section">
      <h2>ğŸ“ æµ‹è¯•æ•°æ®</h2>
      <textarea id="test-data" rows="8" placeholder="è¾“å…¥æµ‹è¯•æ•°æ® (JSON æ ¼å¼)...">
{
  "platform-presets": {
    "custom": [
      { "id": "test-1", "name": "æµ‹è¯•å¹³å°", "url": "https://api.test.com" }
    ],
    "builtInOverrides": {}
  },
  "api-urls": ["https://api.openai.com"],
  "api-keys": ["sk-test-key"]
}
      </textarea>
      <button onclick="uploadTestData()">ä¸Šä¼ åˆ°äº‘ç«¯</button>
      <button class="secondary" onclick="downloadFromCloud()">ä»äº‘ç«¯ä¸‹è½½</button>
      <button class="danger" onclick="clearCloudData()">æ¸…é™¤äº‘ç«¯æ•°æ®</button>
    </div>

    <!-- è‡ªå®šä¹‰åŒæ­¥ç  -->
    <div class="section">
      <h2>ğŸ”‘ è‡ªå®šä¹‰åŒæ­¥ç </h2>
      <input type="text" id="custom-sync-code" placeholder="è‡³å°‘ 8 ä¸ªå­—ç¬¦" style="width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
      <button onclick="setCustomSyncCode()">è®¾ç½®åŒæ­¥ç </button>
    </div>

    <!-- æ—¥å¿— -->
    <div class="section">
      <h2>ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
      <div id="log" class="log"></div>
      <button class="secondary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>
  </div>

  <script type="module">
    // æ¨¡æ‹Ÿ deviceId.js
    async function generateDeviceId() {
      const stored = localStorage.getItem('_device_id')
      if (stored) return stored

      const fingerprint = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset().toString(),
        navigator.hardwareConcurrency?.toString() || '0'
      ].join('|')

      const hashBuffer = await crypto.subtle.digest(
        'SHA-256',
        new TextEncoder().encode(fingerprint)
      )

      const hashArray = Array.from(new Uint8Array(hashBuffer))
      const deviceId = hashArray
        .map(b => b.toString(16).padStart(2, '0'))
        .join('')
        .substring(0, 32)

      localStorage.setItem('_device_id', deviceId)
      return deviceId
    }

    async function getDeviceId() {
      return await generateDeviceId()
    }

    // æ¨¡æ‹Ÿ cloudApi.js
    const API_ENDPOINT = '/api/sync'

    async function uploadToCloud(data) {
      const deviceId = await getDeviceId()

      const response = await fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Device-ID': deviceId
        },
        body: JSON.stringify(data)
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || 'Upload failed')
      }

      return await response.json()
    }

    async function downloadFromCloudAPI() {
      const deviceId = await getDeviceId()

      const response = await fetch(API_ENDPOINT, {
        method: 'GET',
        headers: {
          'X-Device-ID': deviceId
        }
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || 'Download failed')
      }

      return await response.json()
    }

    async function clearCloudDataAPI() {
      const deviceId = await getDeviceId()

      const response = await fetch(API_ENDPOINT, {
        method: 'DELETE',
        headers: {
          'X-Device-ID': deviceId
        }
      })

      if (!response.ok) {
        throw new Error('Clear failed')
      }

      return await response.json()
    }

    // UI æ§åˆ¶
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log')
      const time = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = 'log-entry'
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
    }

    function setStatus(status, text) {
      const statusDiv = document.getElementById('status')
      const statusText = document.getElementById('status-text')

      statusDiv.className = `status ${status}`
      statusText.textContent = text

      if (status === 'syncing') {
        statusDiv.innerHTML = '<span>â³</span><span>' + text + '</span>'
      } else if (status === 'synced') {
        statusDiv.innerHTML = '<span>âœ…</span><span>' + text + '</span>'
      } else if (status === 'error') {
        statusDiv.innerHTML = '<span>âŒ</span><span>' + text + '</span>'
      }
    }

    async function init() {
      const deviceId = await getDeviceId()
      document.getElementById('device-id').textContent = deviceId

      const syncEnabled = localStorage.getItem('_cloud_sync_enabled') !== 'false'
      document.getElementById('sync-enabled').textContent = syncEnabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'

      setStatus('synced', 'å‡†å¤‡å°±ç»ª')
      log('âœ… åˆå§‹åŒ–å®Œæˆ')
      log(`ğŸ“± è®¾å¤‡ ID: ${deviceId}`)
    }

    // æš´éœ²åˆ°å…¨å±€
    window.copyDeviceId = async function() {
      const deviceId = await getDeviceId()
      await navigator.clipboard.writeText(deviceId)
      log('ğŸ“‹ è®¾å¤‡ ID å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
    }

    window.generateNewDeviceId = function() {
      if (confirm('ç¡®å®šè¦ç”Ÿæˆæ–°çš„è®¾å¤‡ ID å—?\nè¿™å°†å¯¼è‡´æ— æ³•è®¿é—®æ—§è®¾å¤‡çš„äº‘ç«¯æ•°æ®ã€‚')) {
        localStorage.removeItem('_device_id')
        location.reload()
      }
    }

    window.uploadTestData = async function() {
      try {
        setStatus('syncing', 'ä¸Šä¼ ä¸­...')
        log('â¬†ï¸ å¼€å§‹ä¸Šä¼ æ•°æ®...')

        const data = JSON.parse(document.getElementById('test-data').value)
        const result = await uploadToCloud(data)

        setStatus('synced', 'ä¸Šä¼ æˆåŠŸ')
        log(`âœ… ä¸Šä¼ æˆåŠŸ! æ—¶é—´æˆ³: ${result.timestamp}`)

        document.getElementById('last-sync').textContent = new Date(result.timestamp).toLocaleString()
      } catch (error) {
        setStatus('error', 'ä¸Šä¼ å¤±è´¥')
        log(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`)
      }
    }

    window.downloadFromCloud = async function() {
      try {
        setStatus('syncing', 'ä¸‹è½½ä¸­...')
        log('â¬‡ï¸ å¼€å§‹ä¸‹è½½æ•°æ®...')

        const data = await downloadFromCloudAPI()

        setStatus('synced', 'ä¸‹è½½æˆåŠŸ')
        log('âœ… ä¸‹è½½æˆåŠŸ!')

        document.getElementById('test-data').value = JSON.stringify(data, null, 2)

        if (data._meta) {
          document.getElementById('last-sync').textContent = new Date(data._meta.lastSync).toLocaleString()
        }
      } catch (error) {
        setStatus('error', 'ä¸‹è½½å¤±è´¥')
        log(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`)
      }
    }

    window.clearCloudData = async function() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤äº‘ç«¯æ•°æ®å—?\næ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) return

      try {
        setStatus('syncing', 'æ¸…é™¤ä¸­...')
        log('ğŸ—‘ï¸ æ¸…é™¤äº‘ç«¯æ•°æ®...')

        await clearCloudDataAPI()

        setStatus('synced', 'æ¸…é™¤æˆåŠŸ')
        log('âœ… äº‘ç«¯æ•°æ®å·²æ¸…é™¤')

        document.getElementById('last-sync').textContent = 'ä»æœªåŒæ­¥'
      } catch (error) {
        setStatus('error', 'æ¸…é™¤å¤±è´¥')
        log(`âŒ æ¸…é™¤å¤±è´¥: ${error.message}`)
      }
    }

    window.setCustomSyncCode = function() {
      const code = document.getElementById('custom-sync-code').value

      if (!code || code.length < 8) {
        alert('åŒæ­¥ç è‡³å°‘éœ€è¦ 8 ä¸ªå­—ç¬¦')
        return
      }

      localStorage.setItem('_device_id', code)
      log(`ğŸ”‘ åŒæ­¥ç å·²è®¾ç½®: ${code}`)
      alert('åŒæ­¥ç å·²è®¾ç½®,é¡µé¢å°†åˆ·æ–°')
      location.reload()
    }

    window.clearLog = function() {
      document.getElementById('log').innerHTML = ''
      log('ğŸ§¹ æ—¥å¿—å·²æ¸…é™¤')
    }

    // åˆå§‹åŒ–
    init()
  </script>
</body>
</html>
